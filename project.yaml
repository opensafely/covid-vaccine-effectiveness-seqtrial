version: '3.0'

expectations:

  population_size: 100000

actions:

  ## # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create-project.R 
  ## Edit and run create-project.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # 
  ##   
  ## # # # # # # # # # # # # # # # # # # # 
  ## Preliminaries 
  ## # # # # # # # # # # # # # # # # # # # 

  design:
    run: r:latest analysis/design.R
    outputs:
      moderately_sensitive:
        lib: lib/design/study-dates.json

  ## # # # # # # # # # # # # # # # # # # # 
  ## SEQUENTIAL TRIAL APPROACH 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process treated data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_treated:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_treated
      --output-file output/sequential/treated/extract/input_treated.feather
    needs:
    - design
    outputs:
      highly_sensitive:
        extract: output/sequential/treated/extract/input_treated.feather

  process_treated:
    run: r:latest analysis/process/process_data.R treated
    needs:
    - extract_treated
    outputs:
      highly_sensitive:
        eligible: output/sequential/treated/eligible/*.rds
        pfizer: output/sequential/pfizer/treated/*.rds
        az: output/sequential/az/treated/*.rds
      moderately_sensitive:
        eligiblecsv: output/sequential/treated/eligible/*.csv
        input_treated_skim: output/sequential/treated/extract/*.txt
        data_processed_skim: output/sequential/treated/process/*.txt
        data_eligible_skim: output/sequential/treated/eligible/*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## pfizer cohort 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match control data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_controlpotential_pfizer_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/sequential/pfizer/matchround1/extract/input_controlpotential.feather
      --param cohort=pfizer --param matching_round=1 --param index_date=2020-12-08
    needs:
    - design
    outputs:
      highly_sensitive:
        cohort: output/sequential/pfizer/matchround1/extract/input_controlpotential.feather

  process_controlpotential_pfizer_1:
    run: r:latest analysis/process/process_data.R potential pfizer 1
    needs:
    - extract_controlpotential_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround1/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/sequential/pfizer/matchround1/extract/potential/*.txt
        data_processed_skim: output/sequential/pfizer/matchround1/potential/*.txt
        data_controlpotential_skim: output/sequential/pfizer/matchround1/process/*.txt

  match_potential_pfizer_1:
    run: r:latest analysis/sequential/matching/match_potential.R pfizer 1
    needs:
    - process_treated
    - process_controlpotential_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround1/potential/*.rds
        csv: output/sequential/pfizer/matchround1/potential/*.csv.gz

  extract_controlactual_pfizer_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/sequential/pfizer/matchround1/extract/input_controlactual.feather
      --param cohort=pfizer --param matching_round=1
    needs:
    - design
    - match_potential_pfizer_1
    outputs:
      highly_sensitive:
        cohort: output/sequential/pfizer/matchround1/extract/input_controlactual.feather

  process_controlactual_pfizer_1:
    run: r:latest analysis/process/process_data.R actual pfizer 1
    needs:
    - process_treated
    - match_potential_pfizer_1
    - extract_controlpotential_pfizer_1
    - process_controlpotential_pfizer_1
    - extract_controlactual_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround1/actual/*.rds
        csv: output/sequential/pfizer/matchround1/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/sequential/pfizer/matchround1/extract/actual/*.txt
        data_actual_skim: output/sequential/pfizer/matchround1/actual/*.txt

  extract_controlpotential_pfizer_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/sequential/pfizer/matchround2/extract/input_controlpotential.feather
      --param cohort=pfizer --param matching_round=2 --param index_date=2020-12-22
    needs:
    - design
    - process_controlactual_pfizer_1
    outputs:
      highly_sensitive:
        cohort: output/sequential/pfizer/matchround2/extract/input_controlpotential.feather

  process_controlpotential_pfizer_2:
    run: r:latest analysis/process/process_data.R potential pfizer 2
    needs:
    - extract_controlpotential_pfizer_2
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround2/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/sequential/pfizer/matchround2/extract/potential/*.txt
        data_processed_skim: output/sequential/pfizer/matchround2/potential/*.txt
        data_controlpotential_skim: output/sequential/pfizer/matchround2/process/*.txt

  match_potential_pfizer_2:
    run: r:latest analysis/sequential/matching/match_potential.R pfizer 2
    needs:
    - process_treated
    - process_controlpotential_pfizer_2
    - process_controlactual_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround2/potential/*.rds
        csv: output/sequential/pfizer/matchround2/potential/*.csv.gz

  extract_controlactual_pfizer_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/sequential/pfizer/matchround2/extract/input_controlactual.feather
      --param cohort=pfizer --param matching_round=2
    needs:
    - design
    - match_potential_pfizer_2
    outputs:
      highly_sensitive:
        cohort: output/sequential/pfizer/matchround2/extract/input_controlactual.feather

  process_controlactual_pfizer_2:
    run: r:latest analysis/process/process_data.R actual pfizer 2
    needs:
    - process_treated
    - match_potential_pfizer_2
    - extract_controlpotential_pfizer_2
    - process_controlpotential_pfizer_2
    - extract_controlactual_pfizer_2
    - process_controlactual_pfizer_1
    outputs:
      highly_sensitive:
        rds: output/sequential/pfizer/matchround2/actual/*.rds
        csv: output/sequential/pfizer/matchround2/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/sequential/pfizer/matchround2/extract/actual/*.txt
        data_actual_skim: output/sequential/pfizer/matchround2/actual/*.txt

  extract_controlfinal_pfizer:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlfinal
      --output-file output/sequential/pfizer/extract/input_controlfinal.feather --param
      cohort=pfizer --param n_matching_rounds=2
    needs:
    - design
    - process_controlactual_pfizer_2
    outputs:
      highly_sensitive:
        extract: output/sequential/pfizer/extract/input_controlfinal.feather

  dummydata_controlfinal_pfizer:
    run: r:latest analysis/dummy/dummydata_controlfinal.R pfizer
    needs:
    - process_controlactual_pfizer_1
    - process_controlactual_pfizer_2
    outputs:
      highly_sensitive:
        dummydata_controlfinal: output/sequential/pfizer/dummydata/dummy_control_final.feather

  process_controlfinal_pfizer:
    run: r:latest analysis/process/process_data.R final pfizer
    needs:
    - process_controlactual_pfizer_1
    - process_controlactual_pfizer_2
    - extract_controlfinal_pfizer
    - process_treated
    - dummydata_controlfinal_pfizer
    outputs:
      highly_sensitive:
        extract: output/sequential/pfizer/match/*.rds
      moderately_sensitive:
        input_controlfinal_skim: output/sequential/pfizer/extract/*.txt
        data_matched_skim: output/sequential/pfizer/match/*.txt

  coverage_pfizer:
    run: r:latest analysis/sequential/matching/coverage.R pfizer
    needs:
    - process_treated
    - process_controlfinal_pfizer
    outputs:
      moderately_sensitive:
        coverage: output/report/coverage/coverage_pfizer.csv

  table1_pfizer:
    run: r:latest analysis/report/table1.R pfizer
    needs:
    - process_treated
    - process_controlfinal_pfizer
    outputs:
      moderately_sensitive:
        coverage: output/report/table1/table1_pfizer.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Model 
  ## # # # # # # # # # # # # # # # # # # # 

  km_pfizer_all_postest:
    run: r:latest analysis/sequential/model/km.R pfizer all postest
    needs:
    - process_controlfinal_pfizer
    outputs:
      moderately_sensitive:
        rds: output/sequential/pfizer/models/km/all/postest/*.rds
        png: output/sequential/pfizer/models/km/all/postest/*.png

  km_pfizer_all_covidadmitted:
    run: r:latest analysis/sequential/model/km.R pfizer all covidadmitted
    needs:
    - process_controlfinal_pfizer
    outputs:
      moderately_sensitive:
        rds: output/sequential/pfizer/models/km/all/covidadmitted/*.rds
        png: output/sequential/pfizer/models/km/all/covidadmitted/*.png

  km_pfizer_all_death:
    run: r:latest analysis/sequential/model/km.R pfizer all death
    needs:
    - process_controlfinal_pfizer
    outputs:
      moderately_sensitive:
        rds: output/sequential/pfizer/models/km/all/death/*.rds
        png: output/sequential/pfizer/models/km/all/death/*.png

  combine_km_pfizer:
    run: r:latest analysis/sequential/model/km_combine.R pfizer
    needs:
    - km_pfizer_all_postest
    - km_pfizer_all_covidadmitted
    - km_pfizer_all_death
    outputs:
      moderately_sensitive:
        rds: output/sequential/pfizer/models/km/combined/*.csv
        png: output/sequential/pfizer/models/km/combined/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## az cohort 
  ## # # # # # # # # # # # # # # # # # # # 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract, process and match control data 
  ## # # # # # # # # # # # # # # # # # # # 

  extract_controlpotential_az_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/sequential/az/matchround1/extract/input_controlpotential.feather
      --param cohort=az --param matching_round=1 --param index_date=2021-01-04
    needs:
    - design
    outputs:
      highly_sensitive:
        cohort: output/sequential/az/matchround1/extract/input_controlpotential.feather

  process_controlpotential_az_1:
    run: r:latest analysis/process/process_data.R potential az 1
    needs:
    - extract_controlpotential_az_1
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround1/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/sequential/az/matchround1/extract/potential/*.txt
        data_processed_skim: output/sequential/az/matchround1/potential/*.txt
        data_controlpotential_skim: output/sequential/az/matchround1/process/*.txt

  match_potential_az_1:
    run: r:latest analysis/sequential/matching/match_potential.R az 1
    needs:
    - process_treated
    - process_controlpotential_az_1
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround1/potential/*.rds
        csv: output/sequential/az/matchround1/potential/*.csv.gz

  extract_controlactual_az_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/sequential/az/matchround1/extract/input_controlactual.feather
      --param cohort=az --param matching_round=1
    needs:
    - design
    - match_potential_az_1
    outputs:
      highly_sensitive:
        cohort: output/sequential/az/matchround1/extract/input_controlactual.feather

  process_controlactual_az_1:
    run: r:latest analysis/process/process_data.R actual az 1
    needs:
    - process_treated
    - match_potential_az_1
    - extract_controlpotential_az_1
    - process_controlpotential_az_1
    - extract_controlactual_az_1
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround1/actual/*.rds
        csv: output/sequential/az/matchround1/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/sequential/az/matchround1/extract/actual/*.txt
        data_actual_skim: output/sequential/az/matchround1/actual/*.txt

  extract_controlpotential_az_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlpotential
      --output-file output/sequential/az/matchround2/extract/input_controlpotential.feather
      --param cohort=az --param matching_round=2 --param index_date=2021-01-18
    needs:
    - design
    - process_controlactual_az_1
    outputs:
      highly_sensitive:
        cohort: output/sequential/az/matchround2/extract/input_controlpotential.feather

  process_controlpotential_az_2:
    run: r:latest analysis/process/process_data.R potential az 2
    needs:
    - extract_controlpotential_az_2
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround2/process/*.rds
      moderately_sensitive:
        input_controlpotential_skim: output/sequential/az/matchround2/extract/potential/*.txt
        data_processed_skim: output/sequential/az/matchround2/potential/*.txt
        data_controlpotential_skim: output/sequential/az/matchround2/process/*.txt

  match_potential_az_2:
    run: r:latest analysis/sequential/matching/match_potential.R az 2
    needs:
    - process_treated
    - process_controlpotential_az_2
    - process_controlactual_az_1
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround2/potential/*.rds
        csv: output/sequential/az/matchround2/potential/*.csv.gz

  extract_controlactual_az_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlactual
      --output-file output/sequential/az/matchround2/extract/input_controlactual.feather
      --param cohort=az --param matching_round=2
    needs:
    - design
    - match_potential_az_2
    outputs:
      highly_sensitive:
        cohort: output/sequential/az/matchround2/extract/input_controlactual.feather

  process_controlactual_az_2:
    run: r:latest analysis/process/process_data.R actual az 2
    needs:
    - process_treated
    - match_potential_az_2
    - extract_controlpotential_az_2
    - process_controlpotential_az_2
    - extract_controlactual_az_2
    - process_controlactual_az_1
    outputs:
      highly_sensitive:
        rds: output/sequential/az/matchround2/actual/*.rds
        csv: output/sequential/az/matchround2/actual/*.csv.gz
      moderately_sensitive:
        input_controlactual_skim: output/sequential/az/matchround2/extract/actual/*.txt
        data_actual_skim: output/sequential/az/matchround2/actual/*.txt

  extract_controlfinal_az:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_controlfinal
      --output-file output/sequential/az/extract/input_controlfinal.feather --param
      cohort=az --param n_matching_rounds=2
    needs:
    - design
    - process_controlactual_az_2
    outputs:
      highly_sensitive:
        extract: output/sequential/az/extract/input_controlfinal.feather

  dummydata_controlfinal_az:
    run: r:latest analysis/dummy/dummydata_controlfinal.R az
    needs:
    - process_controlactual_az_1
    - process_controlactual_az_2
    outputs:
      highly_sensitive:
        dummydata_controlfinal: output/sequential/az/dummydata/dummy_control_final.feather

  process_controlfinal_az:
    run: r:latest analysis/process/process_data.R final az
    needs:
    - process_controlactual_az_1
    - process_controlactual_az_2
    - extract_controlfinal_az
    - process_treated
    - dummydata_controlfinal_az
    outputs:
      highly_sensitive:
        extract: output/sequential/az/match/*.rds
      moderately_sensitive:
        input_controlfinal_skim: output/sequential/az/extract/*.txt
        data_matched_skim: output/sequential/az/match/*.txt

  coverage_az:
    run: r:latest analysis/sequential/matching/coverage.R az
    needs:
    - process_treated
    - process_controlfinal_az
    outputs:
      moderately_sensitive:
        coverage: output/report/coverage/coverage_az.csv

  table1_az:
    run: r:latest analysis/report/table1.R az
    needs:
    - process_treated
    - process_controlfinal_az
    outputs:
      moderately_sensitive:
        coverage: output/report/table1/table1_az.csv

  ## # # # # # # # # # # # # # # # # # # # 
  ## Model 
  ## # # # # # # # # # # # # # # # # # # # 

  km_az_all_postest:
    run: r:latest analysis/sequential/model/km.R az all postest
    needs:
    - process_controlfinal_az
    outputs:
      moderately_sensitive:
        rds: output/sequential/az/models/km/all/postest/*.rds
        png: output/sequential/az/models/km/all/postest/*.png

  km_az_all_covidadmitted:
    run: r:latest analysis/sequential/model/km.R az all covidadmitted
    needs:
    - process_controlfinal_az
    outputs:
      moderately_sensitive:
        rds: output/sequential/az/models/km/all/covidadmitted/*.rds
        png: output/sequential/az/models/km/all/covidadmitted/*.png

  km_az_all_death:
    run: r:latest analysis/sequential/model/km.R az all death
    needs:
    - process_controlfinal_az
    outputs:
      moderately_sensitive:
        rds: output/sequential/az/models/km/all/death/*.rds
        png: output/sequential/az/models/km/all/death/*.png

  combine_km_az:
    run: r:latest analysis/sequential/model/km_combine.R az
    needs:
    - km_az_all_postest
    - km_az_all_covidadmitted
    - km_az_all_death
    outputs:
      moderately_sensitive:
        rds: output/sequential/az/models/km/combined/*.csv
        png: output/sequential/az/models/km/combined/*.png

  ## # # # # # # # # # # # # # # # # # # # 
  ## SINGLE TRIAL APPROACH 
  ## # # # # # # # # # # # # # # # # # # # 
  ## Extract and process data 
  ## # # # # # # # # # # # # # # # # # # # 

  process_single:
    run: r:latest analysis/process/process_data.R single
    needs:
    - extract_treated
    - extract_controlpotential_pfizer_1
    outputs:
      highly_sensitive:
        eligible: output/single/eligible/*.rds
      moderately_sensitive:
        eligiblecsv: output/single/eligible/*.csv
        eligiblecsvgz: output/single/eligible/*.csv.gz
        data_processed_skim: output/single/process/*.txt
        data_eligible_skim: output/single/eligible/*.txt

  table1_single:
    run: r:latest analysis/report/table1.R single
    needs:
    - process_single
    outputs:
      moderately_sensitive:
        coverage: output/report/table1/table1_single.csv

  extract_timevarying:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_timevarying
      --output-file output/single/extract/input_timevarying.feather
    needs:
    - design
    - process_single
    outputs:
      highly_sensitive:
        extract: output/single/extract/input_timevarying.feather

  dummydata_timevarying:
    run: r:latest analysis/dummy/dummydata_timevarying.R
    needs:
    - process_single
    - extract_timevarying
    outputs:
      highly_sensitive:
        dummydata: output/single/dummydata/*.feather

  process_timevarying:
    run: r:latest analysis/single/process/process_timevarying.R
    needs:
    - process_single
    - extract_timevarying
    - dummydata_timevarying
    outputs:
      highly_sensitive:
        processed: output/single/process/*.rds

  process_stset:
    run: r:latest analysis/single/process/process_stset.R
    needs:
    - process_single
    - process_timevarying
    outputs:
      highly_sensitive:
        processed: output/single/stset/*.rds

  ## # # # # # # # # # # # # # # # # # # # 
  ## Model 
  ## # # # # # # # # # # # # # # # # # # # 

  preflight_pfizer_all_postest_150000_50000:
    run: r:latest analysis/single/model/preflight.R pfizer all postest 150000 50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/pfizer/all/postest/preflight/*.csv
        html: output/single/pfizer/all/postest/preflight/*.html

  msm_pfizer_all_postest_150000_50000:
    run: r:latest analysis/single/model/msm.R pfizer all postest 150000 50000
    needs:
    - process_stset
    - preflight_pfizer_all_postest_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/pfizer/all/postest/msm/*.rds
      moderately_sensitive:
        csv: output/single/pfizer/all/postest/msm/*.csv
        png: output/single/pfizer/all/postest/msm/*.png
        txt: output/single/pfizer/all/postest/msm/*.txt

  preflight_pfizer_all_covidadmitted_150000_50000:
    run: r:latest analysis/single/model/preflight.R pfizer all covidadmitted 150000
      50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/pfizer/all/covidadmitted/preflight/*.csv
        html: output/single/pfizer/all/covidadmitted/preflight/*.html

  msm_pfizer_all_covidadmitted_150000_50000:
    run: r:latest analysis/single/model/msm.R pfizer all covidadmitted 150000 50000
    needs:
    - process_stset
    - preflight_pfizer_all_covidadmitted_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/pfizer/all/covidadmitted/msm/*.rds
      moderately_sensitive:
        csv: output/single/pfizer/all/covidadmitted/msm/*.csv
        png: output/single/pfizer/all/covidadmitted/msm/*.png
        txt: output/single/pfizer/all/covidadmitted/msm/*.txt

  preflight_pfizer_all_death_150000_50000:
    run: r:latest analysis/single/model/preflight.R pfizer all death 150000 50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/pfizer/all/death/preflight/*.csv
        html: output/single/pfizer/all/death/preflight/*.html

  msm_pfizer_all_death_150000_50000:
    run: r:latest analysis/single/model/msm.R pfizer all death 150000 50000
    needs:
    - process_stset
    - preflight_pfizer_all_death_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/pfizer/all/death/msm/*.rds
      moderately_sensitive:
        csv: output/single/pfizer/all/death/msm/*.csv
        png: output/single/pfizer/all/death/msm/*.png
        txt: output/single/pfizer/all/death/msm/*.txt

  preflight_az_all_postest_150000_50000:
    run: r:latest analysis/single/model/preflight.R az all postest 150000 50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/az/all/postest/preflight/*.csv
        html: output/single/az/all/postest/preflight/*.html

  msm_az_all_postest_150000_50000:
    run: r:latest analysis/single/model/msm.R az all postest 150000 50000
    needs:
    - process_stset
    - preflight_az_all_postest_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/az/all/postest/msm/*.rds
      moderately_sensitive:
        csv: output/single/az/all/postest/msm/*.csv
        png: output/single/az/all/postest/msm/*.png
        txt: output/single/az/all/postest/msm/*.txt

  preflight_az_all_covidadmitted_150000_50000:
    run: r:latest analysis/single/model/preflight.R az all covidadmitted 150000 50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/az/all/covidadmitted/preflight/*.csv
        html: output/single/az/all/covidadmitted/preflight/*.html

  msm_az_all_covidadmitted_150000_50000:
    run: r:latest analysis/single/model/msm.R az all covidadmitted 150000 50000
    needs:
    - process_stset
    - preflight_az_all_covidadmitted_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/az/all/covidadmitted/msm/*.rds
      moderately_sensitive:
        csv: output/single/az/all/covidadmitted/msm/*.csv
        png: output/single/az/all/covidadmitted/msm/*.png
        txt: output/single/az/all/covidadmitted/msm/*.txt

  preflight_az_all_death_150000_50000:
    run: r:latest analysis/single/model/preflight.R az all death 150000 50000
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/single/az/all/death/preflight/*.csv
        html: output/single/az/all/death/preflight/*.html

  msm_az_all_death_150000_50000:
    run: r:latest analysis/single/model/msm.R az all death 150000 50000
    needs:
    - process_stset
    - preflight_az_all_death_150000_50000
    outputs:
      highly_sensitive:
        rds: output/single/az/all/death/msm/*.rds
      moderately_sensitive:
        csv: output/single/az/all/death/msm/*.csv
        png: output/single/az/all/death/msm/*.png
        txt: output/single/az/all/death/msm/*.txt

  ## # # # # # # # # # # # # # # # # # # # 
  ## REPORT 
  ## # # # # # # # # # # # # # # # # # # # 

  flowchart:
    run: r:latest analysis/report/flowchart.R
    needs:
    - process_treated
    - process_controlfinal_pfizer
    - process_controlfinal_az
    - process_single
    outputs:
      moderately_sensitive:
        flow_matching: output/report/flowchart/*.csv

  brand12counts:
    run: r:latest analysis/report/brand12counts.R
    needs:
    - process_stset
    outputs:
      moderately_sensitive:
        csv: output/report/brand12counts/*.csv
        plots: output/report/brand12counts/*.png

  ## #### End #### 

